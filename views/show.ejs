<% layout('layouts/boilerplate') %>
<body>

  <div class="ns-amb"></div>
  <div class="ns-stars" id="starsContainer"></div>

  <div class="ns-page" style="padding: 2rem;">
    <header class="ns-hdr" style="max-width: 1200px; margin: 0 auto; width: 100%;">
      <div class="ns-logo-n">Evidence Repository</div>
      <a href="/police" class="ns-sub"
        style="width: auto; text-decoration: none; padding: 0.5rem 1.5rem; display: inline-block;">+ Log New
        Evidence</a>
    </header>

    <div style="max-width: 1200px; margin: 0 auto; width: 100%;">
      <div class="ns-table-container">
        <table class="ns-table">
          <thead>
            <tr>
              <th></th>
              <th>Case ID</th>
              <th>Officer ID</th>
              <th>Files</th>
              <th>Uploaded</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <%
              // Group evidences by caseId
              const grouped = {};
              evidences.forEach(e => {
                if (!grouped[e.caseId]) grouped[e.caseId] = [];
                grouped[e.caseId].push(e);
              });
              const cases = Object.entries(grouped);
            %>

            <% if (cases.length === 0) { %>
              <tr>
                <td colspan="6" style="text-align: center; padding: 3rem; color: var(--txt3);">
                  No evidence records found in the repository.
                </td>
              </tr>
            <% } %>

            <% cases.forEach(([caseId, files], index) => { %>
              <!-- Case summary row -->
              <tr class="ns-case-row" onclick="toggleCase(<%= index %>)" style="cursor: pointer;">
                <td style="width: 30px; text-align: center;">
                  <span id="arrow-<%= index %>" style="color: var(--e4); font-size: 0.8rem; transition: transform 0.2s;">‚ñ∂</span>
                </td>
                <td><span class="ns-badge"><%= caseId %></span></td>
                <td><%= files[0].officerId %></td>
                <td>
                  <span style="background: rgba(34,211,238,0.1); border: 1px solid rgba(34,211,238,0.3); color: #22d3ee; padding: 2px 10px; border-radius: 999px; font-size: 0.8rem;">
                    <%= files.length %> file<%= files.length > 1 ? 's' : '' %>
                  </span>
                </td>
                <td style="color: var(--txt2); font-size: 0.85rem;">
                  <%= files[0].createdAt ? new Date(files[0].createdAt).toLocaleDateString('en-IN') : '‚Äî' %>
                </td>
                <td>
                  <a href="/verify?id=<%= files[0].id %>" class="ns-btn-sm"
                    style="text-decoration: none; text-align: center; border-color: var(--e4); color: var(--e4);">
                    üîç Verify All
                  </a>
                </td>
              </tr>

              <!-- Expandable file rows -->
              <tr id="case-<%= index %>" style="display: none;">
                <td colspan="6" style="padding: 0;">
                  <table style="width: 100%; border-collapse: collapse; background: rgba(0,0,0,0.2);">
                    <thead>
                      <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <th style="padding: 0.6rem 1rem; color: var(--txt2); font-size: 0.78rem; text-align: left; width: 30px;">#</th>
                        <th style="padding: 0.6rem 1rem; color: var(--txt2); font-size: 0.78rem; text-align: left;">File Name</th>
                        <th style="padding: 0.6rem 1rem; color: var(--txt2); font-size: 0.78rem; text-align: left;">File Hash</th>
                        <th style="padding: 0.6rem 1rem; color: var(--txt2); font-size: 0.78rem; text-align: left;">IPFS</th>
                        <th style="padding: 0.6rem 1rem; color: var(--txt2); font-size: 0.78rem; text-align: left;">Blockchain Tx</th>
                        <th style="padding: 0.6rem 1rem; color: var(--txt2); font-size: 0.78rem; text-align: left;">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% files.forEach((e, fi) => { %>
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.03);">
                          <td style="padding: 0.6rem 1rem; color: var(--txt3); font-size: 0.82rem;"><%= fi + 1 %></td>
                          <td style="padding: 0.6rem 1rem; font-size: 0.85rem;"><%= e.fileName %></td>
                          <td style="padding: 0.6rem 1rem;">
                            <span title="<%= e.fileHash %>" style="font-family: monospace; color: var(--txt2); font-size: 0.82rem;">
                              <%= e.fileHash.substring(0, 12) %>...
                            </span>
                          </td>
                          <td style="padding: 0.6rem 1rem;">
                            <a href="https://ipfs.io/ipfs/<%= e.ipfsCID %>" target="_blank" class="ns-link" style="font-size: 0.82rem;">
                              View
                            </a>
                          </td>
                          <td style="padding: 0.6rem 1rem;">
                            <span title="<%= e.blockchainTxHash %>" style="font-family: monospace; color: var(--e4); font-size: 0.82rem;">
                              <%= e.blockchainTxHash === 'PENDING_SIGNATURE' ? 'PENDING' : e.blockchainTxHash.substring(0, 12) + '...' %>
                            </span>
                          </td>
                          <td style="padding: 0.6rem 1rem;">
                            <div style="display: flex; gap: 5px;">
                              <a href="/verify?id=<%= e.id %>" class="ns-btn-sm"
                                style="text-decoration: none; text-align: center; border-color: var(--e4); color: var(--e4); font-size: 0.75rem;">
                                üîç Verify
                              </a>
                              <a href="/evidence/retrieve/<%= e.id %>" class="ns-btn-sm"
                                style="text-decoration: none; text-align: center; border-color: #059669; color: #059669; font-size: 0.75rem;">
                                ‚¨áÔ∏èGOlden Copy
                              </a>
                            </div>
                          </td>
                        </tr>
                      <% }) %>
                    </tbody>
                  </table>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    function toggleCase(index) {
      const row = document.getElementById('case-' + index);
      const arrow = document.getElementById('arrow-' + index);
      const isOpen = row.style.display !== 'none';
      row.style.display = isOpen ? 'none' : 'table-row';
      arrow.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(90deg)';
    }
  </script>

</body>