<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nyaya-Setu | The Bridge of Justice</title>
  <link rel="icon" type="image/png" href="/favicon.ico" /> 
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <script src="/js/app.js" defer></script>
</head>
<body>
  <!-- Stars Background -->
  <div class="ns-stars" id="starsContainer"></div>
  <div class="ns-amb"></div>

  <!-- ===== PAGE 1: LANDING ===== -->
  <div id="landingPage" class="ns-page">
    <header class="ns-hdr">
      <div class="ns-logo">
        <svg width="50" height="50" viewBox="0 0 64 64" fill="none">
          <path d="M32 8L8 20V24H56V20L32 8Z" fill="#22d3ee" />
          <rect x="14" y="28" width="6" height="20" rx="1" fill="#22d3ee" opacity="0.9" />
          <rect x="25" y="28" width="6" height="20" rx="1" fill="#22d3ee" opacity="0.9" />
          <rect x="36" y="28" width="6" height="20" rx="1" fill="#22d3ee" opacity="0.9" />
          <rect x="47" y="28" width="6" height="20" rx="1" fill="#22d3ee" opacity="0.9" />
          <rect x="6" y="50" width="52" height="4" rx="1" fill="#22d3ee" opacity="0.8" />
          <rect x="10" y="56" width="44" height="4" rx="1" fill="#22d3ee" opacity="0.6" />
        </svg>
        <div class="ns-logo-t">
          <span class="ns-logo-n">NyayaSetu</span>
          <span class="ns-logo-s">Immutable Evidence Locker</span>
        </div>
      </div>
      <div class="ns-clock" style="font-family: 'Orbitron'; color: #22d3ee;">00:00:00</div>
    </header>

    <section class="ns-cards">
      <div class="ns-cards-g">
        
        <!-- POLICE CARD -->
        <div class="ns-gc" onclick="showSection('policeDashboard')">
          <h2 class="ns-ct">Police Evidence Registration</h2>
          <div class="ns-ri">
            <svg class="ns-ri-out" viewBox="0 0 200 200" fill="none"><circle cx="100" cy="100" r="92" stroke="rgba(0,210,230,0.12)" stroke-width="1" /><circle cx="100" cy="100" r="92" stroke="rgba(0,210,230,0.55)" stroke-width="2" stroke-dasharray="14 8 6 8" stroke-linecap="round" /></svg>
            <svg class="ns-ri-sym" width="60" height="68" viewBox="0 0 56 64" fill="none"><path d="M28 2 L50 14 L50 34 C50 48 38 58 28 62 C18 58 6 48 6 34 L6 14 Z" stroke="#22d3ee" stroke-width="2.5" fill="rgba(0,210,230,0.08)" /><text x="28" y="43" text-anchor="middle" fill="#22d3ee" font-size="28" font-weight="700" font-family="'Orbitron',sans-serif">P</text></svg>
          </div>
          <button class="ns-clb">Register</button>
        </div>

        <!-- JUDGE CARD -->
        <a href="/verify" class="ns-gc ns-gc--gr">
          <h2 class="ns-ct">Judicial Verification</h2>
          <div class="ns-ri">
             <svg class="ns-ri-out" viewBox="0 0 200 200" fill="none"><circle cx="100" cy="100" r="92" stroke="rgba(50,210,130,0.12)" stroke-width="1" /><circle cx="100" cy="100" r="92" stroke="rgba(50,210,130,0.55)" stroke-width="2" stroke-dasharray="14 8 6 8" stroke-linecap="round" /></svg>
             <svg class="ns-ri-sym" width="60" height="60" viewBox="0 0 64 64" fill="none"><rect x="20" y="18" width="40" height="18" rx="4" fill="#34d399" transform="rotate(-45 40 27)" /><rect x="38" y="32" width="6" height="32" rx="3" fill="#34d399" opacity="0.85" transform="rotate(-45 41 32)" /><rect x="8" y="54" width="48" height="6" rx="3" fill="#34d399" opacity="0.6" /></svg>
          </div>
          <button class="ns-clb ns-clb--gr">Verify</button>
        </a>

      </div>
    </section>
  </div>


  <!-- ===== PAGE 2: POLICE DASHBOARD ===== -->
  <div id="policeDashboard" class="ns-page ns-hidden">
    <header class="ns-hdr">
      <button class="ns-btn-sm" onclick="showSection('landingPage')">‚Üê BACK</button>
      <div class="ns-logo-n">Police Dashboard</div>
      <div style="width: 50px;"></div> <!-- Spacer -->
    </header>

    <div class="ns-db-out">
      <div class="ns-db-in">
        <h2 class="ns-ct" style="margin-bottom: 2rem;">Upload Evidence</h2>

        <!-- WALLET CONNECT -->
        <button id="connectBtn" class="ns-sub" onclick="connectWallet()" style="background: #ea580c; margin-bottom: 2rem;">
          ü¶ä Connect MetaMask
        </button>

        <form id="uploadForm">
          <input type="text" class="ns-fi" name="caseId" placeholder="Case Reference Number (e.g., CAS-2026-001)" required>
          <input type="text" class="ns-fi" name="officerId" placeholder="Investigating Officer Badge ID" required>
          
          <label class="ns-fw">
             <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#22d3ee" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
             <span class="ns-fw-lb" style="">Choose Evidence File...</span>
             <span class="ns-fw-st" style="margin-left: auto;">No file selected</span>
             <input type="file" name="file" required>
          </label>

          <button type="submit" id="submitBtn" class="ns-sub" disabled>Upload to IPFS & Blockchain</button>
        </form>

        <div id="statusBox" class="ns-stb"></div>
      </div>
      
      <div style="text-align: center; margin-top: 1rem;">
        <a href="/evidence" class="ns-link">View Evidence Repository</a>
      </div>
    </div>
  </div>

  <script>
    // --- Blockchain Logic (Maintained from original) ---
    let signer;
    let contract;
    
    // --- COPY PASTE YOUR CONTRACT DETAILS HERE ---
    const CONTRACT_ADDRESS = "0x7C9069A677807e4D168e3a7c40bFbe790288Ad18"; 
    const ABI = [
		{
			"anonymous": false,
			"inputs": [
				{
					"indexed": true,
					"internalType": "string",
					"name": "caseId",
					"type": "string"
				},
				{
					"indexed": false,
					"internalType": "string",
					"name": "fileHash",
					"type": "string"
				},
				{
					"indexed": true,
					"internalType": "address",
					"name": "officer",
					"type": "address"
				}
			],
			"name": "EvidenceStored",
			"type": "event"
		},
		{
			"inputs": [
				{
					"internalType": "string",
					"name": "_caseId",
					"type": "string"
				},
				{
					"internalType": "string",
					"name": "_fileHash",
					"type": "string"
				}
			],
			"name": "storeEvidence",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"inputs": [
				{
					"internalType": "string",
					"name": "_caseId",
					"type": "string"
				}
			],
			"name": "verifyEvidence",
			"outputs": [
				{
					"internalType": "string",
					"name": "",
					"type": "string"
				}
			],
			"stateMutability": "view",
			"type": "function"
		}
	];

    async function connectWallet() {
      if (!window.ethereum) return alert("Please install MetaMask!");
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const sepChainId = "0xaa36a7"; // Sepolia
      try {
        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: sepChainId }] });
      } catch (err) {
        if (err.code === 4902) alert("Please add Sepolia Network to MetaMask!");
        return;
      }
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      const address = await signer.getAddress();
      
      const btn = document.getElementById("connectBtn");
      btn.innerHTML = "‚úÖ Connected: " + address.slice(0,6) + "...";
      btn.style.background = "#059669"; // Success Green
      btn.style.cursor = "default";
      
      document.getElementById("submitBtn").disabled = false;
      contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
    }

    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const submitBtn = document.getElementById("submitBtn");
      const statusBox = document.getElementById("statusBox");
      
      submitBtn.style.display = 'none';
      statusBox.className = 'ns-stb loading';
      statusBox.textContent = "‚è≥ Uploading to IPFS & Server...";

      try {
        const formData = new FormData(e.target);
        const response = await fetch('/evidence/upload-api', { method: 'POST', body: formData });
        const data = await response.json();
        
        if(!data.success) throw new Error("Server Upload Failed");

        const { dbId, fileHash, caseId } = data;
        
        statusBox.textContent = "ü¶ä Please Confirm Transaction in MetaMask...";
        
        const tx = await contract.storeEvidence(caseId, fileHash);
        
        statusBox.textContent = "‚è≥ Mining Transaction... Please Wait.";
        await tx.wait(); 
        
        await fetch('/evidence/confirm-tx', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ dbId, txHash: tx.hash })
        });

        statusBox.className = 'ns-stb success';
        statusBox.innerHTML = "üéâ Evidence Secured!<br>Tx: " + tx.hash.slice(0, 10) + "...";
        
        setTimeout(() => { window.location.href = "/evidence"; }, 2000);

      } catch (err) {
        console.error(err);
        submitBtn.style.display = 'block';
        statusBox.className = 'ns-stb error';
        statusBox.textContent = "Error: " + err.message;
      }
    });
  </script>
</body>
</html>